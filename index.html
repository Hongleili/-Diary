<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Personal Diary (Locked)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="My Diary" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root {
      --bg-color: #f5f5f5;
      --card-bg: rgba(255, 255, 255, 0.9);
      --text-color: #1f2933;
      --accent-color: #2563eb;
      --card-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      --soft-bg-image:
        radial-gradient(circle at top left, #e0f2fe, transparent 55%),
        radial-gradient(circle at bottom right, #fee2e2, transparent 55%);
    }

    body.theme-light {
      --bg-color: #f5f5f5;
      --card-bg: rgba(255, 255, 255, 0.92);
      --text-color: #1f2933;
      --accent-color: #2563eb;
      --soft-bg-image:
        radial-gradient(circle at top left, #e0f2fe, transparent 55%),
        radial-gradient(circle at bottom right, #fee2e2, transparent 55%);
    }

    body.theme-cozy {
      --bg-color: #fff7ed;
      --card-bg: rgba(255, 253, 245, 0.96);
      --text-color: #3f2a1d;
      --accent-color: #ea580c;
      --soft-bg-image:
        radial-gradient(circle at top left, #fed7aa, transparent 55%),
        radial-gradient(circle at bottom right, #fee2e2, transparent 55%);
    }

    body.theme-dark {
      --bg-color: #020617;
      --card-bg: rgba(15, 23, 42, 0.96);
      --text-color: #e5e7eb;
      --accent-color: #38bdf8;
      --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
      --soft-bg-image:
        radial-gradient(circle at top left, #0f172a, transparent 55%),
        radial-gradient(circle at bottom right, #020617, transparent 55%);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      background-image: var(--soft-bg-image);
      background-attachment: fixed;
      background-size: cover;
      background-repeat: no-repeat;
      color: var(--text-color);
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 10px;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .theme-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(6px);
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-block;
      margin-bottom: 4px;
    }

    input[type="date"],
    input[type="password"],
    input[type="text"],
    select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
      width: 100%;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.85);
      color: #0f172a;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      resize: vertical;
      font-size: 0.95rem;
      line-height: 1.4;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.9);
      color: #0f172a;
    }

    .inline-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .inline-row {
        grid-template-columns: 1fr;
      }
    }

    .buttons {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: var(--accent-color);
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .status {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #16a34a;
      min-height: 1em;
    }

    .entries-list {
      max-height: 220px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .entry-item {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .entry-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .entry-mood {
      font-size: 1rem;
      width: 1.2rem;
      text-align: center;
    }

    .entry-item:hover {
      background: #e5e7eb;
    }

    .entry-item.active {
      background: var(--accent-color);
      color: white;
    }

    .entry-item.active .entry-mood {
      color: white;
    }

    .no-entries {
      font-size: 0.9rem;
      color: #777;
      margin-top: 8px;
    }

    .small-text {
      font-size: 0.8rem;
      color: #777;
      margin-top: 4px;
    }

    .search-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      align-items: center;
    }

    .search-row input[type="text"] {
      flex: 1;
    }

    .search-row button {
      white-space: nowrap;
    }

    .auto-save-label {
      font-size: 0.8rem;
      color: #16a34a;
    }

    .backup-buttons {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Calendar styles */
    .calendar-section {
      margin-top: 10px;
      border-top: 1px solid #e2e8f0;
      padding-top: 10px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .calendar-nav {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.9rem;
      background: #e5e7eb;
      color: #0f172a;
      border: none;
      cursor: pointer;
    }

    .calendar-month-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .calendar-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      table-layout: fixed;
    }

    .calendar-grid th,
    .calendar-grid td {
      text-align: center;
      padding: 3px 0;
    }

    .calendar-grid thead th {
      color: #64748b;
      font-weight: 600;
    }

    .calendar-cell {
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      height: 26px;
      vertical-align: middle;
    }

    .calendar-cell.empty {
      cursor: default;
    }

    .calendar-cell.has-entry::after {
      content: "";
      position: absolute;
      bottom: 3px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: var(--accent-color);
    }

    .calendar-cell.selected {
      background: var(--accent-color);
      color: white;
    }

    .calendar-cell:hover:not(.empty):not(.selected) {
      background: #e5e7eb;
    }

    /* Mood stats */
    .mood-stats {
      margin-top: 10px;
      border-top: 1px solid #e2e8f0;
      padding-top: 8px;
    }

    .mood-stats-title {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .mood-stat-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 0.8rem;
    }

    .mood-stat-label span {
      margin-left: 4px;
    }

    .mood-stat-bar {
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .mood-stat-bar-inner {
      height: 100%;
      border-radius: 999px;
      background: var(--accent-color);
    }

    .mood-stat-percent {
      font-variant-numeric: tabular-nums;
      color: #64748b;
    }

    /* Lock screen styles */
    .lock-screen-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lock-card {
      max-width: 380px;
      width: 100%;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(8px);
    }

    .lock-title {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    .lock-subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 16px;
    }

    .lock-section {
      margin-top: 10px;
    }

    .lock-buttons {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .lock-status {
      margin-top: 6px;
      font-size: 0.85rem;
      min-height: 1em;
    }

    .lock-status.error {
      color: #dc2626;
    }

    .lock-status.ok {
      color: #16a34a;
    }
  </style>
</head>
<body class="theme-light">
  <!-- Lock screen -->
  <div id="lockScreen" class="lock-screen-wrapper">
    <div class="lock-card">
      <div class="lock-title">üîê My Personal Diary</div>
      <div class="lock-subtitle" id="lockSubtitle">
        Set a password to protect your diary.
      </div>

      <!-- Setup view (first time) -->
      <div id="setupView" class="lock-section" style="display:none;">
        <label for="setupPassword">Create password</label>
        <input type="password" id="setupPassword" autocomplete="new-password" />

        <label for="setupPasswordConfirm" style="margin-top:8px;">Confirm password</label>
        <input type="password" id="setupPasswordConfirm" autocomplete="new-password" />

        <div class="small-text">
          This is stored only on this browser. If you forget it, you can reset by clearing your browser storage for this page,
          but you‚Äôll also lose your diary entries.
        </div>

        <div class="lock-buttons">
          <button class="btn-primary" id="setupSaveBtn">Save password</button>
        </div>
      </div>

      <!-- Login view (after password exists) -->
      <div id="loginView" class="lock-section" style="display:none;">
        <label for="loginPassword">Enter password</label>
        <input type="password" id="loginPassword" autocomplete="current-password" />

        <div class="lock-buttons">
          <button class="btn-primary" id="loginBtn">Unlock diary</button>
        </div>

        <div class="small-text">
          If you truly forget your password, you can clear this site‚Äôs data in your browser settings.
          That will remove the password and all diary entries.
        </div>
      </div>

      <div id="lockStatus" class="lock-status"></div>
    </div>
  </div>

  <!-- Main diary app (hidden until unlocked) -->
  <div id="appContainer" style="display:none;">
    <div class="app">
      <h1>My Personal Diary </h1>
      <div class="subtitle">A private space just for your thoughts ‚ú®</div>

      <div class="top-controls">
        <div class="theme-controls">
          <label for="themeSelect">Theme</label>
          <select id="themeSelect">
            <option value="light">Light</option>
            <option value="cozy">Cozy</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div class="auto-save-label">Auto-save: on</div>
      </div>

      <div class="layout">
        <!-- Left: editor -->
        <div class="card">
          <div>
            <label for="dateInput">Choose a date</label><br />
            <input type="date" id="dateInput" />
          </div>

          <div class="inline-row">
            <div>
              <label for="moodSelect">Mood</label>
              <select id="moodSelect">
                <option value="">(no mood)</option>
                <option value="very_happy">üòÑ Very happy</option>
                <option value="happy">üòä Happy</option>
                <option value="calm">üôÇ Calm</option>
                <option value="neutral">üòê Neutral</option>
                <option value="tired">üò¥ Tired</option>
                <option value="worried">üòü Worried</option>
                <option value="sad">üò¢ Sad</option>
                <option value="angry">üò° Angry</option>
                <option value="grateful">üôè Grateful</option>
              </select>
            </div>
            <div>
              <label for="tagsInput">Tags</label>
              <input
                type="text"
                id="tagsInput"
                placeholder="e.g. treatment, work, family"
              />
            </div>
          </div>

          <div>
            <label for="entryText" style="margin-top:10px; display:block;">Today's entry</label>
            <textarea id="entryText" placeholder="Write anything you like..."></textarea>
          </div>

          <div class="buttons">
            <button class="btn-primary" id="saveBtn" type="button">Save entry</button>
            <button class="btn-secondary" id="clearBtn" type="button">Clear text</button>
            <button class="btn-secondary" id="voiceBtn" type="button">üéôÔ∏è Dictate</button>
          </div>

          <div class="status" id="statusText"></div>
          <div class="small-text">
            All diary entries (text, mood, tags) are stored only in this browser using local storage.
          </div>
        </div>

        <!-- Right: entries list + search + calendar + stats -->
        <div class="card">
          <strong>Past entries</strong>
          <div class="small-text">
            Search by text or tags. Leave empty to see everything.
          </div>

          <div class="search-row">
            <input
              type="text"
              id="searchInput"
              placeholder="Search (e.g. 'treatment', 'energy', 'teaching')"
            />
            <button class="btn-secondary" id="clearSearchBtn" type="button">Clear</button>
          </div>

          <div id="entriesList" class="entries-list"></div>

          <button class="btn-danger" id="deleteAllBtn" style="margin-top:10px;" type="button">
            Delete all entries
          </button>
          <div class="small-text">
            ‚ö†Ô∏è This will permanently delete everything from this browser.
          </div>

         <div class="backup-buttons">
  <button class="btn-secondary" id="exportJsonBtn" type="button">Export JSON</button>
  <button class="btn-secondary" id="exportTextBtn" type="button">Export text</button>
  <button class="btn-secondary" id="importJsonBtn" type="button">Import JSON</button>
  <!-- hidden file input for import -->
  <input
    type="file"
    id="importJsonInput"
    accept="application/json"
    style="display:none"
  />
</div>
<div class="small-text">
  Use export to create a backup file you can store safely, and import JSON to restore or sync from that backup (e.g. from OneDrive).
</div>


          <div class="calendar-section">
            <div class="calendar-header">
              <button class="calendar-nav" id="prevMonthBtn" type="button">‚Äπ</button>
              <span class="calendar-month-label" id="calendarMonthLabel"></span>
              <button class="calendar-nav" id="nextMonthBtn" type="button">‚Ä∫</button>
            </div>
            <table class="calendar-grid">
              <thead>
                <tr>
                  <th>Mon</th>
                  <th>Tue</th>
                  <th>Wed</th>
                  <th>Thu</th>
                  <th>Fri</th>
                  <th>Sat</th>
                  <th>Sun</th>
                </tr>
              </thead>
              <tbody id="calendarBody"></tbody>
            </table>
          </div>

          <div class="mood-stats">
            <div class="mood-stats-title">Mood statistics</div>
            <div id="moodStatsContainer" class="mood-stats-body small-text">
              No mood data yet.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "myPersonalDiaryEntries";
    const PASSWORD_KEY = "myPersonalDiaryPassword";
    const THEME_KEY = "myDiaryTheme";
    let currentSearchQuery = "";
    let currentCalendarDate = null;
    let autoSaveTimer = null;

    /* ===== Helper: mood ‚Üí emoji & label ===== */
    function moodToEmoji(mood) {
      switch (mood) {
        case "very_happy": return "üòÑ";
        case "happy": return "üòä";
        case "calm": return "üôÇ";
        case "neutral": return "üòê";
        case "tired": return "üò¥";
        case "worried": return "üòü";
        case "sad": return "üò¢";
        case "angry": return "üò°";
        case "grateful": return "üôè";
        default: return "";
      }
    }

    function moodToLabel(mood) {
      switch (mood) {
        case "very_happy": return "Very happy";
        case "happy": return "Happy";
        case "calm": return "Calm";
        case "neutral": return "Neutral";
        case "tired": return "Tired";
        case "worried": return "Worried";
        case "sad": return "Sad";
        case "angry": return "Angry";
        case "grateful": return "Grateful";
        default: return "";
      }
    }

    /* ===== Theme handling ===== */
    function applyTheme(theme) {
      const t = theme || "light";
      document.body.classList.remove("theme-light", "theme-cozy", "theme-dark");
      document.body.classList.add("theme-" + t);
      const select = document.getElementById("themeSelect");
      if (select) select.value = t;
      localStorage.setItem(THEME_KEY, t);
    }

    /* ===== Diary storage functions ===== */
    function loadEntries() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw) || {};
      } catch (e) {
        console.error("Error reading entries:", e);
        return {};
      }
    }

    function saveEntries(entries) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    // Handle old entries (plain text) & new entries (object with text/mood/tags)
    function normalizeEntry(rawEntry) {
      if (rawEntry === undefined || rawEntry === null) {
        return { text: "", mood: "", tags: [] };
      }
      if (typeof rawEntry === "string") {
        return { text: rawEntry, mood: "", tags: [] };
      }
      if (typeof rawEntry === "object") {
        return {
          text: rawEntry.text || "",
          mood: rawEntry.mood || "",
          tags: Array.isArray(rawEntry.tags) ? rawEntry.tags : [],
        };
      }
      return { text: "", mood: "", tags: [] };
    }

    function formatDateForDisplay(dateStr) {
      if (!dateStr) return "";
      const [year, month, day] = dateStr.split("-");
      return `${day}/${month}/${year}`;
    }

    function refreshEntriesList(selectedDate) {
      const entries = loadEntries();
      const listEl = document.getElementById("entriesList");
      listEl.innerHTML = "";

      const dates = Object.keys(entries).sort(); // chronological
      const query = (currentSearchQuery || "").trim().toLowerCase();

      const filteredDates = dates.filter(date => {
        if (!query) return true;
        const entry = normalizeEntry(entries[date]);
        const tagsText = (entry.tags || []).join(" ");
        const haystack = `${entry.text} ${tagsText}`.toLowerCase();
        return haystack.includes(query);
      });

      if (filteredDates.length === 0) {
        const emptyMsg = document.createElement("div");
        emptyMsg.className = "no-entries";
        emptyMsg.textContent = query
          ? "No entries match your search."
          : "No entries yet. Start by writing something and clicking Save.";
        listEl.appendChild(emptyMsg);
        return;
      }

      filteredDates.forEach(date => {
        const rawEntry = entries[date];
        const entry = normalizeEntry(rawEntry);
        const moodIcon = moodToEmoji(entry.mood);

        const item = document.createElement("div");
        item.className = "entry-item" + (date === selectedDate ? " active" : "");

        const left = document.createElement("div");
        left.className = "entry-left";

        const moodSpan = document.createElement("span");
        moodSpan.className = "entry-mood";
        moodSpan.textContent = moodIcon || "";

        const dateSpan = document.createElement("span");
        dateSpan.textContent = formatDateForDisplay(date);

        left.appendChild(moodSpan);
        left.appendChild(dateSpan);
        item.appendChild(left);

        item.addEventListener("click", () => {
          const dateInput = document.getElementById("dateInput");
          const textArea = document.getElementById("entryText");
          const moodSelect = document.getElementById("moodSelect");
          const tagsInput = document.getElementById("tagsInput");

          dateInput.value = date;

          const e = normalizeEntry(entries[date]);
          textArea.value = e.text || "";
          moodSelect.value = e.mood || "";
          tagsInput.value = e.tags && e.tags.length ? e.tags.join(", ") : "";

          showStatus(`Loaded entry for ${formatDateForDisplay(date)}.`, false);
          refreshEntriesList(date);
          renderCalendar(date);
        });

        listEl.appendChild(item);
      });
    }

    function showStatus(message, isError = false) {
      const statusEl = document.getElementById("statusText");
      statusEl.style.color = isError ? "#dc2626" : "#16a34a";
      statusEl.textContent = message;
      if (message) {
        setTimeout(() => {
          if (statusEl.textContent === message) {
            statusEl.textContent = "";
          }
        }, 2500);
      }
    }

    /* ===== Mood statistics ===== */
    function renderMoodStats() {
      const container = document.getElementById("moodStatsContainer");
      const entries = loadEntries();
      const dates = Object.keys(entries);
      const counts = {};
      let total = 0;

      dates.forEach(date => {
        const entry = normalizeEntry(entries[date]);
        if (entry.mood) {
          counts[entry.mood] = (counts[entry.mood] || 0) + 1;
          total++;
        }
      });

      container.innerHTML = "";
      if (total === 0) {
        container.textContent = "No mood data yet.";
        return;
      }

      Object.keys(counts)
        .sort((a, b) => counts[b] - counts[a])
        .forEach(mood => {
          const count = counts[mood];
          const percent = Math.round((count * 100) / total);
          const row = document.createElement("div");
          row.className = "mood-stat-row";

          const label = document.createElement("div");
          label.className = "mood-stat-label";
          label.innerHTML = `${moodToEmoji(mood)} <span>${moodToLabel(mood)}</span>`;

          const bar = document.createElement("div");
          bar.className = "mood-stat-bar";
          const inner = document.createElement("div");
          inner.className = "mood-stat-bar-inner";
          inner.style.width = `${percent}%`;
          bar.appendChild(inner);

          const pct = document.createElement("div");
          pct.className = "mood-stat-percent";
          pct.textContent = `${percent}% (${count})`;

          row.appendChild(label);
          row.appendChild(bar);
          row.appendChild(pct);
          container.appendChild(row);
        });
    }

    /* ===== Calendar ===== */
    function renderCalendar(selectedDateStr) {
      const body = document.getElementById("calendarBody");
      const label = document.getElementById("calendarMonthLabel");
      const entries = loadEntries();

      if (!currentCalendarDate) {
        const today = new Date();
        currentCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
      }

      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      label.textContent = currentCalendarDate.toLocaleString(undefined, {
        month: "long",
        year: "numeric",
      });

      body.innerHTML = "";

      const firstDay = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let startOffset = (firstDay.getDay() + 6) % 7; // Mon=0
      let day = 1;

      for (let week = 0; week < 6; week++) {
        const tr = document.createElement("tr");
        for (let dow = 0; dow < 7; dow++) {
          const td = document.createElement("td");
          td.className = "calendar-cell";

          if ((week === 0 && dow < startOffset) || day > daysInMonth) {
            td.classList.add("empty");
            td.textContent = "";
          } else {
            const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
            td.textContent = day;

            const rawEntry = entries[dateStr];
            const entry = rawEntry ? normalizeEntry(rawEntry) : null;
            if (entry && (entry.text || entry.mood || (entry.tags && entry.tags.length))) {
              td.classList.add("has-entry");
            }
            if (dateStr === selectedDateStr) {
              td.classList.add("selected");
            }

            td.addEventListener("click", () => {
              const dateInput = document.getElementById("dateInput");
              const textArea = document.getElementById("entryText");
              const moodSelect = document.getElementById("moodSelect");
              const tagsInput = document.getElementById("tagsInput");

              dateInput.value = dateStr;
              const entriesNow = loadEntries();
              const e = normalizeEntry(entriesNow[dateStr]);
              textArea.value = e.text || "";
              moodSelect.value = e.mood || "";
              tagsInput.value = e.tags && e.tags.length ? e.tags.join(", ") : "";

              refreshEntriesList(dateStr);
              renderCalendar(dateStr);
              showStatus(`Loaded entry for ${formatDateForDisplay(dateStr)}.`, false);
            });

            day++;
          }
          tr.appendChild(td);
        }
        body.appendChild(tr);
        if (day > daysInMonth) break;
      }
    }

    /* ===== Backup / export ===== */
    function downloadFile(filename, content, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportJsonBackup() {
      const entries = loadEntries();
      const data = JSON.stringify(entries, null, 2);
      const now = new Date();
      const stamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, "0")}${String(
        now.getDate()
      ).padStart(2, "0")}-${String(now.getHours()).padStart(2, "0")}${String(
        now.getMinutes()
      ).padStart(2, "0")}`;
      const name = `diary-backup-${stamp}.json`;
      downloadFile(name, data, "application/json");
      showStatus("Exported JSON backup.", false);
    }

    function exportTextBackup() {
      const entries = loadEntries();
      const dates = Object.keys(entries).sort();
      let lines = [];

      dates.forEach(date => {
        const e = normalizeEntry(entries[date]);
        const moodLabel = e.mood ? moodToLabel(e.mood) : "None";
        const tagsText = e.tags && e.tags.length ? e.tags.join(", ") : "None";
        lines.push(
          "==== " + date + " (" + formatDateForDisplay(date) + ") ====",
          "Mood: " + moodLabel,
          "Tags: " + tagsText,
          "",
          e.text || "",
          ""
        );
      });

      const text = lines.join("\n");
      const now = new Date();
      const stamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, "0")}${String(
        now.getDate()
      ).padStart(2, "0")}-${String(now.getHours()).padStart(2, "0")}${String(
        now.getMinutes()
      ).padStart(2, "0")}`;
      const name = `diary-backup-${stamp}.txt`;
      downloadFile(name, text, "text/plain");
      showStatus("Exported text backup.", false);
    }
function importJsonBackupFromFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const text = event.target.result;
      const imported = JSON.parse(text);

      if (!imported || typeof imported !== "object") {
        showStatus("Invalid JSON file for import.", true);
        return;
      }

      const current = loadEntries();
      // Simple rule: imported entries overwrite existing entries for the same date
      const merged = { ...current, ...imported };
      saveEntries(merged);

      // Try to refresh using today's date (or any date)
      const dateInput = document.getElementById("dateInput");
      const currentDate = dateInput ? dateInput.value : null;

      refreshEntriesList(currentDate || undefined);
      renderCalendar(currentDate || undefined);
      renderMoodStats();

      showStatus("Imported entries from JSON backup.", false);
    } catch (e) {
      console.error("Import error:", e);
      showStatus("Failed to import JSON backup.", true);
    }
  };
  reader.onerror = () => {
    showStatus("Could not read the file.", true);
  };
  reader.readAsText(file);
}

    /* ===== Auto-save ===== */
    function saveCurrentEntry(options = { auto: false }) {
      const dateInput = document.getElementById("dateInput");
      const textArea = document.getElementById("entryText");
      const moodSelect = document.getElementById("moodSelect");
      const tagsInput = document.getElementById("tagsInput");

      const date = dateInput.value;
      const text = textArea.value;
      const mood = moodSelect.value || "";
      const tagsRaw = tagsInput.value || "";

      if (!date) {
        if (!options.auto) {
          showStatus("Please choose a date before saving.", true);
        }
        return;
      }

      const tags = tagsRaw
        .split(",")
        .map(t => t.trim())
        .filter(t => t.length > 0);

      const entries = loadEntries();
      entries[date] = { text, mood, tags };
      saveEntries(entries);

      refreshEntriesList(date);
      renderCalendar(date);
      renderMoodStats();

      if (options.auto) {
        showStatus("Auto-saved.", false);
      } else {
        showStatus(`Saved entry for ${formatDateForDisplay(date)}.`, false);
      }
    }

    function scheduleAutoSave() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        saveCurrentEntry({ auto: true });
      }, 1200);
    }

    /* ===== Diary app init (after unlock) ===== */
    function initDiaryApp() {
      const dateInput = document.getElementById("dateInput");
      const textArea = document.getElementById("entryText");
      const moodSelect = document.getElementById("moodSelect");
      const tagsInput = document.getElementById("tagsInput");
      const saveBtn = document.getElementById("saveBtn");
      const clearBtn = document.getElementById("clearBtn");
      const deleteAllBtn = document.getElementById("deleteAllBtn");
      const searchInput = document.getElementById("searchInput");
      const clearSearchBtn = document.getElementById("clearSearchBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const exportTextBtn = document.getElementById("exportTextBtn");
const importJsonBtn = document.getElementById("importJsonBtn");
const importJsonInput = document.getElementById("importJsonInput");

      const prevMonthBtn = document.getElementById("prevMonthBtn");
      const nextMonthBtn = document.getElementById("nextMonthBtn");
      const voiceBtn = document.getElementById("voiceBtn");

      // Set default date to today
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const todayStr = `${yyyy}-${mm}-${dd}`;
      dateInput.value = todayStr;

      // Load today's entry if exists
      const entries = loadEntries();
      const todayEntry = normalizeEntry(entries[todayStr]);
      textArea.value = todayEntry.text || "";
      moodSelect.value = todayEntry.mood || "";
      tagsInput.value = todayEntry.tags && todayEntry.tags.length
        ? todayEntry.tags.join(", ")
        : "";

      currentCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);

      refreshEntriesList(todayStr);
      renderCalendar(todayStr);
      renderMoodStats();

      // Manual save
      saveBtn.addEventListener("click", () => {
        saveCurrentEntry({ auto: false });
      });

      clearBtn.addEventListener("click", () => {
        textArea.value = "";
        moodSelect.value = "";
        tagsInput.value = "";
        showStatus("Cleared text, mood, and tags. Don't forget to save if you want it blank.");
      });

      deleteAllBtn.addEventListener("click", () => {
        const really = confirm("Are you sure you want to delete ALL diary entries?");
        if (!really) return;
        localStorage.removeItem(STORAGE_KEY);
        textArea.value = "";
        moodSelect.value = "";
        tagsInput.value = "";
        refreshEntriesList(dateInput.value);
        renderCalendar(dateInput.value);
        renderMoodStats();
        showStatus("All entries deleted.", false);
      });

      dateInput.addEventListener("change", () => {
        const date = dateInput.value;
        const entriesNow = loadEntries();
        const entry = normalizeEntry(entriesNow[date]);
        textArea.value = entry.text || "";
        moodSelect.value = entry.mood || "";
        tagsInput.value = entry.tags && entry.tags.length
          ? entry.tags.join(", ")
          : "";
        refreshEntriesList(date);
        renderCalendar(date);
      });

      // Auto-save triggers
      textArea.addEventListener("input", scheduleAutoSave);
      moodSelect.addEventListener("change", scheduleAutoSave);
      tagsInput.addEventListener("input", scheduleAutoSave);

      // Search handling
      searchInput.addEventListener("input", () => {
        currentSearchQuery = searchInput.value || "";
        refreshEntriesList(dateInput.value);
      });

      clearSearchBtn.addEventListener("click", () => {
        searchInput.value = "";
        currentSearchQuery = "";
        refreshEntriesList(dateInput.value);
      });

      // Backup buttons
      // Backup buttons
exportJsonBtn.addEventListener("click", exportJsonBackup);
exportTextBtn.addEventListener("click", exportTextBackup);

importJsonBtn.addEventListener("click", () => {
  // Trigger the hidden file input
  importJsonInput.click();
});

importJsonInput.addEventListener("change", () => {
  const file = importJsonInput.files && importJsonInput.files[0];
  if (file) {
    importJsonBackupFromFile(file);
  }
  // Reset so selecting the same file again still fires change
  importJsonInput.value = "";
});


      // Calendar navigation
      prevMonthBtn.addEventListener("click", () => {
        if (!currentCalendarDate) {
          currentCalendarDate = new Date();
        }
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendar(dateInput.value);
      });

      nextMonthBtn.addEventListener("click", () => {
        if (!currentCalendarDate) {
          currentCalendarDate = new Date();
        }
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendar(dateInput.value);
      });

      // Theme selector
      const themeSelect = document.getElementById("themeSelect");
      const savedTheme = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(savedTheme);
      themeSelect.addEventListener("change", (e) => {
        applyTheme(e.target.value);
      });

      // Voice-to-text (if supported)
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        voiceBtn.style.display = "none";
      } else {
        let recognition = new SpeechRecognition();
        let isRecording = false;
        recognition.lang = "en-GB";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = (event) => {
          let finalTranscript = "";
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const res = event.results[i];
            if (res.isFinal) {
              finalTranscript += res[0].transcript;
            }
          }
          if (finalTranscript) {
            textArea.value += (textArea.value ? " " : "") + finalTranscript.trim();
            scheduleAutoSave();
          }
        };

        recognition.onerror = () => {
          isRecording = false;
          voiceBtn.textContent = "üéôÔ∏è Dictate";
        };

        recognition.onend = () => {
          if (isRecording) {
            isRecording = false;
            voiceBtn.textContent = "üéôÔ∏è Dictate";
          }
        };

        function startDictation() {
          recognition.start();
          isRecording = true;
          voiceBtn.textContent = "‚èπ Stop";
        }

        function stopDictation() {
          recognition.stop();
          isRecording = false;
          voiceBtn.textContent = "üéôÔ∏è Dictate";
        }

        voiceBtn.addEventListener("click", () => {
          if (isRecording) {
            stopDictation();
          } else {
            startDictation();
          }
        });
      }
    }

    /* ===== Password handling ===== */
    function getStoredPassword() {
      return localStorage.getItem(PASSWORD_KEY);
    }

    function setStoredPassword(password) {
      // For simplicity we store plaintext. This is not secure encryption.
      localStorage.setItem(PASSWORD_KEY, password);
    }

    function showSetupView() {
      document.getElementById("setupView").style.display = "block";
      document.getElementById("loginView").style.display = "none";
      document.getElementById("lockSubtitle").textContent =
        "Set a password to protect your diary.";
      setLockStatus("");
    }

    function showLoginView() {
      document.getElementById("setupView").style.display = "none";
      document.getElementById("loginView").style.display = "block";
      document.getElementById("lockSubtitle").textContent =
        "Enter your password to unlock your diary.";
      setLockStatus("");
    }

    function setLockStatus(msg, isError = false) {
      const el = document.getElementById("lockStatus");
      el.textContent = msg;
      el.classList.remove("error", "ok");
      if (!msg) return;
      el.classList.add(isError ? "error" : "ok");
    }

    function unlockDiary() {
      const input = document.getElementById("loginPassword");
      const entered = input.value || "";
      const stored = getStoredPassword();

      if (!stored) {
        setLockStatus("No password is set. Please reload the page.", true);
        return;
      }

      if (entered === stored) {
        // Success: hide lock screen, show app
        document.getElementById("lockScreen").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        initDiaryApp();
      } else {
        setLockStatus("Incorrect password. Please try again.", true);
        input.value = "";
        input.focus();
      }
    }

    function setupPassword() {
      const p1 = document.getElementById("setupPassword").value || "";
      const p2 = document.getElementById("setupPasswordConfirm").value || "";

      if (!p1 || !p2) {
        setLockStatus("Please fill in both password fields.", true);
        return;
      }
      if (p1.length < 4) {
        setLockStatus("Please use at least 4 characters.", true);
        return;
      }
      if (p1 !== p2) {
        setLockStatus("Passwords do not match. Please try again.", true);
        return;
      }

      setStoredPassword(p1);
      setLockStatus("Password saved. Please use it to unlock.", false);
      showLoginView();
    }

    /* ===== Initial page setup ===== */
    document.addEventListener("DOMContentLoaded", () => {
      // Apply saved theme even on lock screen
      const savedTheme = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(savedTheme);

      const storedPassword = getStoredPassword();

      document.getElementById("setupSaveBtn").addEventListener("click", setupPassword);
      document.getElementById("loginBtn").addEventListener("click", unlockDiary);

      document.getElementById("loginPassword").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          unlockDiary();
        }
      });

      document.getElementById("setupPasswordConfirm").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          setupPassword();
        }
      });

      if (!storedPassword) {
        showSetupView();
      } else {
        showLoginView();
      }
    });

    /* ===== PWA: register service worker ===== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
